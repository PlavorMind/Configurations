Define logDirectory "${ApacheHTTPdDirectory}/private/logs"
SetEnvIfExpr true logType=main

<IfModule unixd_module>
  Define moduleDirectory "/usr/lib/apache2/modules"
  Define SSLCertificatesDirectory "/plavormind/ssl-certificates"
  Define webDirectory "/plavormind/web/public"
</IfModule>

<IfModule !unixd_module>
  Define moduleDirectory "${ApacheHTTPdDirectory}/app/modules"
  Define SSLCertificatesDirectory "C:/plavormind/ssl-certificates"
  Define webDirectory "C:/plavormind/web/public"
  ServerRoot "${ApacheHTTPdDirectory}/app"
</IfModule>

LoadModule authz_core_module "${moduleDirectory}/mod_authz_core.so"
LoadModule authz_host_module "${moduleDirectory}/mod_authz_host.so"
LoadModule dir_module "${moduleDirectory}/mod_dir.so"
LoadModule headers_module "${moduleDirectory}/mod_headers.so"
LoadModule http2_module "${moduleDirectory}/mod_http2.so"
LoadModule mime_module "${moduleDirectory}/mod_mime.so"
LoadModule proxy_module "${moduleDirectory}/mod_proxy.so"
LoadModule proxy_fcgi_module "${moduleDirectory}/mod_proxy_fcgi.so"
LoadModule rewrite_module "${moduleDirectory}/mod_rewrite.so"
LoadModule setenvif_module "${moduleDirectory}/mod_setenvif.so"
LoadModule ssl_module "${moduleDirectory}/mod_ssl.so"

<IfModule unixd_module>
  LoadModule mpm_event_module "${moduleDirectory}/mod_mpm_event.so"
</IfModule>

<IfModule !unixd_module>
  LoadModule log_config_module "${moduleDirectory}/mod_log_config.so"
</IfModule>

# DirectoryIndex must be explicitly reset first otherwise it will append to existing values.
DirectoryIndex disabled
DirectoryIndex "index.php" "index.html"
DocumentRoot "${webDirectory}/fallback"
EnableMMAP Off
ErrorDocument 403 "403 Forbidden: You do not have permission to access this page."
ErrorDocument 404 "404 Not Found: Cannot find requested page."
ErrorLog "${logDirectory}/fallback/error.log"
Header always add Content-Security-Policy "frame-ancestors 'none';"
Listen 81
Listen 443
LogFormat "%t %h \"%r\" (host: \"%V\", status: %>s, UA: \"%{User-agent}i\", Referer: \"%{Referer}i\")" main
LogLevel ssl:error
Options None
Protocols h2 h2c http/1.1
RewriteOptions InheritDown
ServerName localhost
ServerTokens Prod
SSLCertificateFile "${SSLCertificatesDirectory}/main.crt"
SSLCertificateKeyFile "${SSLCertificatesDirectory}/main.key"
SSLEngine on
SSLHonorCipherOrder on
SSLProtocol TLSv1.3
SSLSessionTickets off
TimeOut 30
TraceEnable off

CustomLog "${logDirectory}/fallback/request.log" main

RewriteCond "%{DOCUMENT_ROOT}%{REQUEST_URI}" !-f
RewriteRule "^\/(favicon\.ico|robots\.txt)$" "${webDirectory}/global%{REQUEST_URI}" [L]

<IfModule unixd_module>
  MaxRequestWorkers 150
  MaxSpareThreads 75
  MinSpareThreads 25
  StartServers 2
  ThreadLimit 64
  ThreadsPerChild 25
  TypesConfig "/etc/mime.types"

  <IfDefine APACHE_PID_FILE>
    PidFile "${APACHE_PID_FILE}"
  </IfDefine>

  <IfDefine APACHE_RUN_DIR>
    DefaultRuntimeDir "${APACHE_RUN_DIR}"
  </IfDefine>

  <IfDefine APACHE_RUN_GROUP>
    Group "${APACHE_RUN_GROUP}"
  </IfDefine>

  <IfDefine APACHE_RUN_USER>
    User "${APACHE_RUN_USER}"
  </IfDefine>
</IfModule>

<IfModule !unixd_module>
  PidFile "${ApacheHTTPdDirectory}/private/process-id.txt"
  ProxyFCGIBackendType GENERIC
  # Apache HTTP Server prepends "/" to SCRIPT_FILENAME on Windows.
  ProxyFCGISetEnvIf "reqenv('SCRIPT_FILENAME') =~ m#^\/([A-Z]:\/.+)#i" SCRIPT_FILENAME "$1"
</IfModule>

<Directory "/">
  Require all denied
</Directory>

<FilesMatch ".\.php$">
  <If "-f %{REQUEST_FILENAME}">
    <IfModule unixd_module>
      SetHandler "proxy:unix:/run/php/php8.1-fpm.sock|fcgi://localhost"
    </IfModule>

    <IfModule !unixd_module>
      SetHandler "proxy:fcgi://127.0.0.1:9000/"
    </IfModule>
  </If>
</FilesMatch>

<Location "/">
  <RequireAll>
    Require all granted
    IncludeOptional "${ApacheHTTPdDirectory}/private/settings/banned-ips.conf"
  </RequireAll>
</Location>

<Location "/robots.txt">
  Require method GET
</Location>

# fallback
<VirtualHost *:81>
  # RewriteEngine is never inherited so that it must be specified for each virtual hosts.
  RewriteEngine on
  SSLEngine off

  <Location "/internal">
    Require ip 127.0.0.0/24 ::1/128 192.168.0.0/16
  </Location>
</VirtualHost>

# https-fallback
<VirtualHost *:443>
  CustomLog "${logDirectory}/https-fallback/request.log" main
  ErrorLog "${logDirectory}/https-fallback/error.log"

  <Location "/">
    Require all denied
  </Location>
</VirtualHost>

# https-redirect
<VirtualHost *:81>
  CustomLog "${logDirectory}/https-redirect/request.log" main
  ErrorLog "${logDirectory}/https-redirect/error.log"
  RewriteEngine on
  ServerAlias *.plavormind.io
  ServerName plavormind.io
  SSLEngine off

  # PCRE requires escaping "-" next to character class.
  RewriteCond "%{HTTP_HOST}" "^([\d\w\-.]+)(?::\d+)?$" [NC]
  RewriteRule "." "https://%1%{REQUEST_URI}" [L,QSA,R=301]
</VirtualHost>

# main
<VirtualHost *:443>
  DocumentRoot "${webDirectory}/main"
  ErrorLog "${logDirectory}/main/error.log"
  # Firefox makes favicons also subject to Content Security Policy.
  Header always add Content-Security-Policy "default-src 'none'; img-src 'self';"
  Header always setifempty Referrer-Policy "same-origin"
  Header always setifempty X-Content-Type-Options "nosniff"
  LogFormat "%t %h \"%r\" (status: %>s, UA: \"%{User-agent}i\", Referer: \"%{Referer}i\")" single-host
  RewriteEngine on
  ServerName plavormind.io

  CustomLog "${logDirectory}/main/request.log" single-host
</VirtualHost>

# wikis
<VirtualHost *:443>
  SetEnvIf Request_URI "^\/favicon\.ico$" logType=extra
  SetEnvIf Request_URI "^\/mediawiki\/api\.php$" logType=api
  SetEnvIf Request_URI "^\/mediawiki\/img_auth\.php(?:$|\/)" logType=extra
  SetEnvIf Request_URI "^\/mediawiki\/(?:load|thumb)\.php$" logType=extra
  SetEnvIf Request_URI "^\/mediawiki\/rest\.php(?:$|\/)" logType=api
  SetEnvIf Request_URI "^\/mediawiki\/(?:extension|resource|skin)s\/.+\.(?:png|svg)$" logType=extra
  SetEnvIf Request_URI "^\/resources\/" logType=extra

  AllowEncodedSlashes NoDecode
  CustomLog "${logDirectory}/wikis/request-api.log" main "expr=reqenv('logType') == 'api'"
  CustomLog "${logDirectory}/wikis/request-extra.log" main "expr=reqenv('logType') == 'extra'"
  CustomLog "${logDirectory}/wikis/request-main.log" main "expr=reqenv('logType') == 'main'"
  DocumentRoot "${webDirectory}/wikis"
  ErrorLog "${logDirectory}/wikis/error.log"
  RewriteEngine on
  RewriteRule "^\/$" "%{DOCUMENT_ROOT}/mediawiki/index.php" [L,QSA]
  RewriteRule "^\/(?:delete|edit|history|info|markpatrolled|p(?:a|ur)ge|raw|re(?:nder|vert)|rollback|submit|(?:un)?protect|(?:un)?watch)(?:$|\/)" "%{DOCUMENT_ROOT}/mediawiki/index.php" [L,QSA]
  ServerAlias *.plavormind.io
  ServerName wikis
  TimeOut 60

  <Location "/mediawiki">
    Require all denied
  </Location>

  <Location "/mediawiki/COPYING">
    <RequireAll>
      Require method GET
      IncludeOptional "${ApacheHTTPdDirectory}/private/settings/banned-ips.conf"
    </RequireAll>
  </Location>

  <LocationMatch "^\/mediawiki\/[^\/]+\.php$">
    <RequireAll>
      Require all granted
      IncludeOptional "${ApacheHTTPdDirectory}/private/settings/banned-ips.conf"
    </RequireAll>
  </LocationMatch>

  # Allow access to subpaths of img_auth.php and rest.php
  <LocationMatch "^\/mediawiki\/(?:img_auth|rest)\.php\/">
    <RequireAll>
      Require all granted
      IncludeOptional "${ApacheHTTPdDirectory}/private/settings/banned-ips.conf"
    </RequireAll>
  </LocationMatch>

  <Location "/mediawiki/LocalSettings.php">
    Require all denied
  </Location>

  <Location "/mediawiki/thumb.php">
    Header always add Content-Security-Policy "default-src 'none'; img-src 'self';"
  </Location>

  <LocationMatch "^\/mediawiki\/(?:extension|resource|skin)s\/.+\.(?:png|svg)$">
    <RequireAll>
      Require method GET
      IncludeOptional "${ApacheHTTPdDirectory}/private/settings/banned-ips.conf"
    </RequireAll>
  </LocationMatch>

  <Location "/mediawiki/mw-config">
    Require ip 127.0.0.0/24 ::1/128 192.168.0.0/16
  </Location>

  <Location "/resources">
    Header always add Content-Security-Policy "default-src 'none'; img-src 'self';"
    Header always set X-Content-Type-Options "nosniff"
  </Location>
</VirtualHost>
