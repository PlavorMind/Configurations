user "www-data"; #linux_only #not_on_macos #not_on_windows
worker_processes auto; #linux_only #not_on_macos #not_on_windows
events
{multi_accept on;
worker_connections 100;}
http
{include "fastcgi.conf";
include "mime.types";
include "private/black*.conf";
include "private/block*.conf";

map "" $server_os
{
default "Linux" #linux_only
default "macOS" #macos_only
default "Windows" #windows_only
}

map $server_os $logs_directory
{default "logs";
"Linux" "/etc/nginx/logs";}
map $server_os $php_cgi_bind_path
{default "127.0.0.1:9000";
"Linux" "unix:/var/run/php/php7.2-fpm.sock";}
map $server_os $web_directory
{default "/plavormind/web";
"Windows" "C:/plavormind/web";}

#access_log "/etc/nginx/logs/main/access.log"; #linux_only #not_on_macos #not_on_windows
#access_log "logs/main/access.log"; #windows_only #not_on_linux #not_on_macos
access_log $logs_directory/main/access.log;
client_max_body_size 500M;
default_type "application/octet-stream";
#error_log "/etc/nginx/logs/main/error.log"; #linux_only #not_on_macos #not_on_windows
#error_log "logs/main/error.log"; #windows_only #not_on_linux #not_on_macos
error_log $logs_directory/main/error.log;
error_page 403 404 500 501 502 503 504 /error/$status.html;
fastcgi_index "index.php";
gzip on; #linux_only #not_on_macos #not_on_windows
gzip_proxied any;
gzip_types "application/javascript" "application/json" "application/xml" "application/xml+rss" "text/css" "text/javascript" "text/plain" "text/xml";
gzip_vary on;
index "index.php" "index.html";
log_not_found off;
#sendfile on; #Disabled for test
server_tokens off;
ssl_prefer_server_ciphers on;
ssl_protocols "TLSv1" "TLSv1.1" "TLSv1.2" "TLSv1.3";
ssl_session_cache shared:SSL:1m;
ssl_session_timeout 1m;
#tcp_nodelay on; #Disabled for test
#tcp_nopush on; #Disabled by default, enable this for test when sendfile is on
keepalive_timeout 1m 1m;
root $web_directory/main;

#main
server
  {include "global.conf";
  include "private/global*.conf";

  listen 81 default_server;
  listen [::]:81 default_server;

  location = "/robots.txt"
    {
    access_log "/etc/nginx/logs/main/robots.log"; #linux_only #not_on_macos #not_on_windows
    access_log "logs/main/robots.log"; #windows_only #not_on_linux #not_on_macos
    allow all;
    try_files $uri @global_robots;}
  location ^~ "/adminer"
    {allow "127.0.0.0/24";
    allow "::1/128";
    allow "192.168.0.0/16";
    deny all;
    location ~* ".+\.php"
      {fastcgi_pass $php_cgi_bind_path;
      try_files $uri =404;}
    }
  location ~* ".+\.php"
    {fastcgi_pass $php_cgi_bind_path;
    try_files $uri =404;}
  location @global_robots
    {
    access_log "/etc/nginx/logs/main/robots.log"; #linux_only #not_on_macos #not_on_windows
    access_log "logs/main/robots.log"; #windows_only #not_on_linux #not_on_macos
    allow all;
    root $web_directory/global;}
  }
#public
server
  {include "global.conf";
  include "private/global*.conf";

  access_log "/etc/nginx/logs/public/access.log"; #linux_only #not_on_macos #not_on_windows
  access_log "logs/public/access.log"; #windows_only #not_on_linux #not_on_macos
  error_log "/etc/nginx/logs/public/error.log"; #linux_only #not_on_macos #not_on_windows
  error_log "logs/public/error.log"; #windows_only #not_on_linux #not_on_macos
  listen 81;
  listen [::]:81;
  #listen 443 ssl;
  #listen [::]:443 ssl;
  root $web_directory/public;
  server_name "plavormind.tk";

  location = "/robots.txt"
    {
    access_log "/etc/nginx/logs/public/robots.log"; #linux_only #not_on_macos #not_on_windows
    access_log "logs/public/robots.log"; #windows_only #not_on_linux #not_on_macos
    allow all;
    try_files $uri @global_robots;}
  location ~* ".+\.php"
    {fastcgi_pass $php_cgi_bind_path;
    try_files $uri =404;}
  location @global_robots
    {
    access_log "/etc/nginx/logs/public/robots.log"; #linux_only #not_on_macos #not_on_windows
    access_log "logs/public/robots.log"; #windows_only #not_on_linux #not_on_macos
    allow all;
    root $web_directory/global;}
  }
#wiki
server
  {include "global.conf";
  include "private/global*.conf";

  access_log "/etc/nginx/logs/wiki/access.log"; #linux_only #not_on_macos #not_on_windows
  access_log "logs/wiki/access.log"; #windows_only #not_on_linux #not_on_macos
  error_log "/etc/nginx/logs/wiki/error.log"; #linux_only #not_on_macos #not_on_windows
  error_log "logs/wiki/error.log"; #windows_only #not_on_linux #not_on_macos
  listen 81;
  listen [::]:81;
  #listen 443 ssl;
  #listen [::]:443 ssl;
  root $web_directory/wiki;
  server_name "*.plavormind.tk";

  location = "/"
    {return 302 $scheme://$http_host/page/;}
  location = "/mediawiki/api.php"
    {
    access_log "/etc/nginx/logs/wiki/api.log"; #linux_only #not_on_macos #not_on_windows
    access_log "logs/wiki/api.log"; #windows_only #not_on_linux #not_on_macos
    fastcgi_pass $php_cgi_bind_path;
    try_files $uri =404;}
  location = "/mediawiki/COPYING"
    {}
  location = "/mediawiki/LocalSettings.php"
    {deny all;}
  location = "/robots.txt"
    {
    access_log "/etc/nginx/logs/wiki/robots.log"; #linux_only #not_on_macos #not_on_windows
    access_log "logs/wiki/robots.log"; #windows_only #not_on_linux #not_on_macos
    allow all;
    try_files $uri @global_robots;}
  location ^~ "/mediawiki/img_auth.php"
    {fastcgi_pass $php_cgi_bind_path;}
  location ^~ "/mediawiki/mw-config"
    {allow "127.0.0.0/24";
    allow "::1/128";
    allow "192.168.0.0/16";
    deny all;
    location ~* ".+\.php"
      {fastcgi_pass $php_cgi_bind_path;
      try_files $uri =404;}
    }
  location ^~ "/mediawiki_old"
    {deny all;}
  location ~* "\/(delete|edit|history|info|markpatrolled|p(a|ur)ge|raw|re(nder|vert)|rollback|submit|(un)?protect|(un)?watch)"
    {include "fastcgi.conf";
    fastcgi_param "SCRIPT_FILENAME" $document_root/mediawiki/index.php;
    fastcgi_pass $php_cgi_bind_path;}
  location ~* "\/mediawiki\/(load|thumb(_handler)?)\.php"
    {access_log off;
    fastcgi_pass $php_cgi_bind_path;
    try_files $uri =404;}
  location ~* "\/mediawiki\/[^\/]+\.php"
    {fastcgi_pass $php_cgi_bind_path;
    try_files $uri =404;}
  location ~* "\/mediawiki\/(data|extensions|resources|skins)\/.+\.(gif|jpe?g|png|webp)" #Same as $wgFileExtensions
    {access_log off;}
  location ~* "\/mediawiki"
    {deny all;}
  location @global_robots
    {
    access_log "/etc/nginx/logs/wiki/robots.log"; #linux_only #not_on_macos #not_on_windows
    access_log "logs/wiki/robots.log"; #windows_only #not_on_linux #not_on_macos
    allow all;
    root $web_directory/global;}
  }
}
